# Internals

This page documents internals that are not meant to be used by the users.

```@contents
Pages = ["internals.md"]
```

## Parsing

The conversion from XML to the internal representation of ATDF format heavily relies on the generated function [`AtmelToolsDeviceFiles.node_to_atdf`](@ref).

```@docs
AtmelToolsDeviceFiles.node_to_atdf
```

The main bit of [`AtmelToolsDeviceFiles.node_to_atdf`](@ref) is `@generated` and is intended to use [`AtmelToolsDeviceFiles.AbstractATDF`](@ref) subtypes as a template for interpreting the `XML.Node` object it has been fed.

```@docs
AtmelToolsDeviceFiles.AbstractATDF
```

This approach simplifies the description of the format as it relies mostly on the defined structures in `types.jl`. 

!!! notes "Schema"
    The structures are built from the inferred schema from examples of files I have found so far. Unfortunately I was unable to find a proper schema on the internet yet. If you are in possiession of such a schema from Microship please reach out, for example [by opening an issue](https://github.com/Klafyvel/AtmelToolsDeviceFiles.jl/issues/new/choose)!

Of course, the structures themselve are not exactly enough to define the XML schema, so we define a set of helper functions. We can define four kind of data we want to fetch from the XML code: attributes, single-valued structures, direct children arrays, wrapped children arrays.

### Attribute fetching

```@docs
AtmelToolsDeviceFiles._build_xml_attribute_name
AtmelToolsDeviceFiles._generate_attribute_fetching
```

### Single-valued child structures

```@docs
AtmelToolsDeviceFiles._generate_single_child_fetching
```

### Direct children arrays

```@docs
AtmelToolsDeviceFiles._generate_children_name
AtmelToolsDeviceFiles._generate_children_fetching
```

### Wrapped children arrays

```@docs
AtmelToolsDeviceFiles._has_wrapper_children
AtmelToolsDeviceFiles._generate_wrapper_children_name
AtmelToolsDeviceFiles._special_wrapped_children_name
AtmelToolsDeviceFiles._fetch_wrapped_children
AtmelToolsDeviceFiles._generate_wrapped_children_fetching
```

### `node_to_atdf` generated methods structure

Reading the source code of [`AtmelToolsDeviceFiles.node_to_atdf`](@ref) is probably the best option. However, we give here a summary of what the structure of generated methods look like.

1. Attributes fetching. If the node is expected to have attributes, we fetch them and run the `checkcode` expressions generated by [`AtmelToolsDeviceFiles._generate_attribute_fetching`](@ref).
2. Declaration of the variables used by single-valued children and array children. Single-valued children variables are initialized as `nothing` and arrays as empty arrays.
3. A `for` loop that iterates over the children and checks if it needs to trigger the `fetchcode` of the single-valued childrent, array children, or wrapped array children.
4. Check over all single-valued children that they are not `nothing` after the loop (we do not allow optional structure single-valued children at the time).
5. Build the internal representation of the node from the extracted variables.

